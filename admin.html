<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<script src="https://hima-kumi.github.io/point-app/env.js?v=1"></script>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>スタンプ管理（クラシック）</title>
<!-- 最優先で API_URL を定義 -->
<style>
  :root{
    --bg:#f5f7fb; --card:#ffffff; --bd:#e5e7eb; --ink:#1f2937; --sub:#6b7280;
    --blue:#0d6efd; --blue2:#0b5ed7; --red:#ef4444;
  }
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;}
  .wrap{max-width:980px;margin:0 auto;padding:16px;}
  h1{font-size:20px;margin:0 0 10px;font-weight:800}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;box-shadow:0 8px 18px rgba(0,0,0,.04);margin-bottom:12px}
  .muted{color:var(--sub);font-size:12px}
  .row{display:grid;gap:10px}
  @media(min-width:860px){ .row{grid-template-columns:420px 1fr} }
  input,select{width:100%;padding:11px;border:1px solid var(--bd);border-radius:10px;font-size:16px;background:#fff}
  .btn{padding:10px 14px;border:none;border-radius:10px;font-weight:700;color:#fff;cursor:pointer}
  .btn.primary{background:var(--blue)}
  .btn.primary:hover{background:var(--blue2)}
  .btn.ghost{background:#f8fafc;color:#111;border:1px solid var(--bd)}
  .btn.danger{background:var(--red)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .kv{display:grid;grid-template-columns:110px 1fr;gap:6px;align-items:center}
  .k{color:var(--sub);font-size:12px}
  .big{font-size:26px;font-weight:900}
  .line{height:1px;background:var(--bd);margin:10px 0}
  /* スキャナ */
  .scan{position:relative;border-radius:10px;overflow:hidden;background:#000}
  video{width:100%;height:auto;display:block}
  canvas{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h1>スタンプ管理</h1>

  <div class="row">
    <!-- 左：ログイン・検索 -->
    <section class="card">
      <div class="muted">スタッフログイン</div>
      <div class="grid2" style="margin-top:6px">
        <input id="staffId" placeholder="staff_id（例: master）">
        <input id="pin" type="password" placeholder="PIN（例: 1234）">
      </div>
      <div style="margin-top:8px">
        <button id="btnLogin" class="btn primary">ログイン</button>
        <button id="btnTest" class="btn ghost">シート確認</button>
        <span id="loginMsg" class="muted"></span>
      </div>

      <div class="line"></div>

      <div class="muted">会員を検索（氏名 / 電話 / ID）</div>
      <div class="grid2" style="margin-top:6px">
        <input id="q" placeholder="例: 山田 / 080… / m1762…">
        <button id="btnSearch" class="btn ghost">検索</button>
      </div>
      <div id="list" style="max-height:170px;overflow:auto;margin-top:8px"></div>
    </section>

    <!-- 右：会員詳細・操作 -->
    <section class="card">
      <div class="muted">選択中の会員</div>
      <div class="kv" style="margin-top:6px">
        <div class="k">会員ID</div><div id="m_id">—</div>
        <div class="k">お名前</div><div id="m_name">—</div>
        <div class="k">電話</div><div id="m_phone">—</div>
        <div class="k">保有</div><div class="big" id="m_st">0</div>
      </div>

      <div style="margin-top:10px">
        <button class="btn primary" data-d="+1">+1</button>
        <button class="btn primary" data-d="+5">+5</button>
        <button class="btn danger"  data-d="-1">-1</button>
        <span id="opMsg" class="muted"></span>
      </div>

      <div class="line"></div>

      <div class="muted" style="margin-bottom:6px">引換プリセット</div>
      <div id="presets" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </section>
  </div>

  <!-- スキャナ（任意） -->
  <section class="card">
    <div class="muted">会員QRを読み取る（ログイン後）</div>
    <div class="scan" style="aspect-ratio:4/3;margin-top:8px;max-width:640px">
      <video id="video" playsinline></video>
    </div>
    <div style="margin-top:8px">
      <button id="btnCamStart" class="btn ghost">カメラ起動</button>
      <button id="btnCamStop"  class="btn ghost">停止</button>
      <input id="filePick" type="file" accept="image/*" style="margin-left:6px">
    </div>
    <canvas id="canvas"></canvas>
  </section>
</div>

<!-- QRライブラリ -->
<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
/* ======= 基本：API呼び出し ======= */
if(!window.API_URL){ alert('env.js の API_URL が未設定です（/exec を指定）'); }
async function api(name, data){
  const res = await fetch(API_URL, {
    method: 'POST',
    mode: 'cors',
    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
    body: JSON.stringify({ action: name, data: data }),
  });
  if(!res.ok) throw new Error('network_error');
  return await res.json();
}
const $ = s => document.querySelector(s);

let STAFF = ''; // ログイン済み staff_id

/* ======= ログイン（UI内表示で結果を通知） ======= */
$('#btnLogin').onclick = async ()=>{
  const sid = $('#staffId').value.trim();
  const pin = $('#pin').value.trim();
  if(!sid || !pin){ $('#loginMsg').textContent = 'ID / PIN を入力'; return; }
  $('#loginMsg').textContent = '照合中…';
  try{
    const r = await api('staff_login', { staff_id:sid, pin });
    if(r && r.ok){ STAFF = r.staff_id; $('#loginMsg').textContent = `ログインしました（${STAFF}）`; loadPresets(); }
    else { $('#loginMsg').textContent = 'ログイン失敗'; }
  }catch(e){ $('#loginMsg').textContent = '通信エラー'; }
};

/* ======= ▲▲▲ここから追加▲▲▲ ======= */
$('#btnTest').onclick = async () => {
  $('#loginMsg').textContent = 'シート設定を確認中...';
  try {
    const r = await api('test_staff_sheet');
    // 成功した場合も、失敗した場合も、サーバーからの返答をすべて表示する
    alert('サーバーからの応答:\n' + JSON.stringify(r, null, 2));
    if (r && r.ok) {
      $('#loginMsg').textContent = 'シートは正常に認識されています。';
    } else {
      $('#loginMsg').textContent = 'シート確認でエラーが検出されました。';
    }
  } catch (e) {
    // 通信自体に失敗した場合のエラーを詳細に表示
    $('#loginMsg').textContent = '通信エラーが発生しました。';
    alert('通信エラーの詳細:\n' + e.toString() + '\n\n' + JSON.stringify(e));
  }
};
/* ======= ▲▲▲ここまで追加▲▲▲ ======= */

/* ======= 検索 → 選択 ======= */
$('#btnSearch').onclick = async ()=>{
  const q = $('#q').value.trim();
  const host = $('#list'); host.innerHTML = '検索中…';
  try{
    const list = await api('search_members', { q });
    host.innerHTML = '';
    if(!list || !list.length){ host.innerHTML = '<div class="muted">該当なし</div>'; return; }
    list.forEach(m=>{
      const div = document.createElement('div');
      div.style.cssText='display:flex;justify-content:space-between;align-items:center;border:1px solid var(--bd);border-radius:10px;padding:8px;background:#fff;margin:6px 0;';
      div.innerHTML = `<div><b>${m.name||'(無名)'}</b><div class="muted">ID:${m.member_id}／${m.phone||''}</div></div><button class="btn ghost">選択</button>`;
      div.querySelector('button').onclick = ()=> setMember(m.member_id);
      host.appendChild(div);
    });
  }catch(e){ host.innerHTML='<div class="muted">通信エラー</div>'; }
};

async function setMember(id){
  const m = await api('get_member', { member_id:id });
  if(!m){ alert('会員が見つかりません'); return; }
  $('#m_id').textContent = m.member_id;
  $('#m_name').textContent = m.name || '—';
  $('#m_phone').textContent = m.phone || '—';
  $('#m_st').textContent = m.stamps_total;
  $('#opMsg').textContent = '';
}

/* ======= クイック付与 ======= */
document.querySelectorAll('[data-d]').forEach(b=>{
  b.onclick = async ()=>{
    if(!STAFF){ alert('先にログインしてください'); return; }
    const id = $('#m_id').textContent.trim();
    if(!id || id==='—'){ alert('会員を選択してください'); return; }
    const delta = Number(b.dataset.d);
    try{
      const r = await api('adjust_stamps', { member_id:id, delta, reason:(delta>0?'quick_add':'quick_sub'), staff_id:STAFF });
      if(!r || !r.ok){ $('#opMsg').textContent='失敗しました'; return; }
      $('#m_st').textContent = r.after;
      $('#opMsg').textContent = (delta>=0?'+':'') + delta + ' 反映しました';
    }catch(e){ $('#opMsg').textContent='通信エラー'; }
  };
});

/* ======= プリセット ======= */
async function loadPresets(){
  const host = $('#presets'); host.innerHTML = '読込中…';
  try{
    const ps = await api('get_presets');
    host.innerHTML = '';
    ps.forEach(p=>{
      const el = document.createElement('button');
      el.className='btn ghost';
      el.textContent = `${p.item}（${p.cost}）`;
      el.onclick = async ()=>{
        const id = $('#m_id').textContent.trim();
        if(!id || id==='—'){ alert('会員を選択してください'); return; }
        const r = await api('redeem_by_preset', { member_id:id, item:p.item, staff_id:STAFF });
        if(!r || !r.ok){ alert('引換不可'); return; }
        $('#m_st').textContent = r.after;
        $('#opMsg').textContent = `「${p.item}」を引換しました`;
      };
      host.appendChild(el);
    });
  }catch(e){ host.innerHTML='<span class="muted">通信エラー</span>'; }
}

/* ======= カメラ・QR ======= */
const video = $('#video'), canvas = $('#canvas'), ctx = canvas.getContext('2d');
let stream=null, raf=null;

$('#btnCamStart').onclick = async ()=>{
  if(!STAFF){ alert('先にログインしてください'); return; }
  await startCam();
};
$('#btnCamStop').onclick  = stopCam;

async function startCam(){
  stopCam();
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
    video.srcObject = stream; await video.play(); loop();
  }catch(e){ alert('カメラを開始できません'); }
}
function stopCam(){
  if(raf) cancelAnimationFrame(raf), raf=null;
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  if(video) video.pause();
}
function loop(){
  if(!video.videoWidth){ raf = requestAnimationFrame(loop); return; }
  const w=video.videoWidth,h=video.videoHeight;
  canvas.width=w; canvas.height=h; ctx.drawImage(video,0,0,w,h);
  const img = ctx.getImageData(0,0,w,h);
  const code = jsQR(img.data,w,h,{inversionAttempts:'dontInvert'});
  if(code && code.data){ onQR(code.data); stopCam(); return; }
  raf = requestAnimationFrame(loop);
}
function parseMemberId(text){
  try{ const u=new URL(text); const id=u.searchParams.get('id'); if(id) return id; }catch(_){}
  if(/^m\d{10,}$/.test(text)) return text;
  return '';
}
async function onQR(data){
  const id = parseMemberId(data);
  if(!id){ alert('会員IDを抽出できません'); return; }
  await setMember(id);
}
document.getElementById('filePick').addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0]; if(!f) return;
  const img = new Image();
  img.onload = function(){
    canvas.width=img.width; canvas.height=img.height; ctx.drawImage(img,0,0);
    const d=ctx.getImageData(0,0,canvas.width,canvas.height); const code=jsQR(d.data,canvas.width,canvas.height);
    if(code && code.data) onQR(code.data); else alert('QRを認識できませんでした');
  };
  img.src = URL.createObjectURL(f);
});
</script>
</body>
</html>
